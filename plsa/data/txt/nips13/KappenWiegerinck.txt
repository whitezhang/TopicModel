Second order approximations for probability 
models 
Hilbert J. Kappen 
Department of Biophysics 
Nijmegen University 
Nijmegen, the Netherlands 
bert@mbfys. kun. nl 
Wim Wiegerinck 
Department of Biophysics 
Nijmegen University 
Nijmegen, the Netherlands 
wimw@mb fys. kun. nl 
Abstract 
In this paper, we derive a second order mean field theory for directed 
graphical probability models. By using an information theoretic argu- 
ment it is shown how this can be done in the absense of a partition 
function. This method is a direct generalisation of the well-known TAP 
approximation for Boltzmann Machines. In a numerical example, it is 
shown that the method greatly improves the first order mean field ap- 
proximation. For a restricted class of graphical models, so-called single 
overlap graphs, the second order method has comparable complexity to 
the first order method. For sigmoid belief networks, the method is shown 
to be particularly fast and effective. 
1 Introduction 
Recently, a number of authors have proposed deterministic methods for approximate infer- 
ence in large graphical models. The simplest approach gives a lower bound on the prob- 
ability of a subset of variables using Jenssen's inequality (Saul et al., 1996). The method 
involves the minimization of the KL divergence between the target probability distribution 
p and some 'simple' variational distribution q. The method can be applied to a large class 
of probability models, such as sigmoid belief networks, DAGs and Boltzmann Machines 
(BM). 
For Boltzmann-Gibbs distributions, it is possible to derive the lower bound as the first 
term in a Taylor series expansion of the free energy around a factorized model. The free 
energy is given by - log Z, where Z is the normalization constant of the Boltzmann-Gibbs 
distribution: p(a:) exp(-(x)) This Taylor series can be continued and the second order 
-- Z 
term is known as the TAP correction (Plefka, 1982; Kappen and Rodrfguez, 1998). The 
second order term significantly improves the quality of the approximation, but is no longer 
a bound. 
For probability distributions that are not Boltzmann-Gibbs distributions, it is not obvious 
how to obtain the second order approximation. However, there is an alternative way to 
compute the higher order corrections, based on an information theoretic argument. Re- 
cently, this argument was applied to stochastic neural networks with asymmetric connec- 
tivity (Kappen and Spanjers, 1999). Here, we apply this idea to directed graphical models. 
2 The method 
Let z = (z,..., z) be an n-dimensional vector, with zi taking on discrete values. Let 
p(z) be a directed graphical model on z. We will assume that p(z) can be written as a 
product of potentials in the following way: 
p(x) = H Pk(xklrk) = exp E (Pk(x)' (1) 
k=l k=l 
Here, p (x ]r) denotes the conditional probability table of variable xk given the values 
of its parents r. x  - (x, r) denotes the subset of variables that appear in potential k 
and (pk(x ) - logp(x ]r). Potentials can be overlapping, x k F] x t  , and x - [.Jx . 
We wish to compute the marginal probability that xi has some specific value si in the 
presence of some evidence. We therefore denote x - (e, s) where e denote the subset of 
variables that constitute the evidence, and s denotes the remainder of the variables. The 
marginal is given as 
p(sle) = p(si, e) (2) 
p(e) 
Both numerator and denominator contain sums over hidden states. These sums scale ex- 
ponentially with the size of the problem, and therefore the computation of marginals is 
intractable. 
We propose to approximate this problem by using a mean field approach. Consider a fac- 
torized distribution on the hidden variables h: 
q(s) = H qi(si) 
(3) 
We wish to find the factorized distribution q that best approximates p(sle). Consider as a 
distance measure 
KL = y'p(sle) log f p(sle) ' 
[, q(s) J' 
s 
It is easy to see that the q that minimizes KL satisfies: 
q(si) = p(sle) 
(4) 
(5) 
We now think of the manifold of all probability distributions of the form Eq. 1, spanned 
by the coordinates (pn(xn),k = 1,...,m. For each k, (pk(x n) is a table of numbers, 
indexed by x n. This manifold contains a submanifold of factorized probability distri- 
butions in which the potentials factorize: (p(x ) = Y4,ek (p(x). When in addition, 
Y]-,ie cPi(xi) = log qi(xi), i ß h, p(sle) reduces to q(s). 
Assume now that p(sle) is somehow close to the factorized submanifold. The difference 
Ap(sil e) = p(sil e) -qi(si) is then small, and we can expand this small difference in terms 
of changes in the parameters ACk(x n) = (pn(x n) -- logq(xn),k = 1,... ,m: 
 (alogp(sile)) 
Alogp(sile) = y y k, b--(- ACk() 
k=l  q 
1 ( 021ogp(sil e) 
kl  , 
+ higher order terms 
) t ) 
q 
(6) 
The differentials are evaluated in the factorized distribution q. The left-hand size of Eq. 6 is 
zero because of Eq. 5 and we solve for q($i). This factorized distribution gives the desired 
marginals up to the order of the expansion of A logp($i le). 
It is straightforward to compute the derivatives: 
Ologp($ile) 
OOk(Z k) 
020gp($il e) 
OOk(k)OOt( t) 
= V(kl$, e) -- V(kle ) 
p(k, t I$, e) - p( k, t I) 
-p(k I$i, )p(tl$i, ) + p(kl)p(tle) 
(7) 
We introduce the notation (..-)8 and (...) as the expectation values with respect to the 
factorized distributions q(a:l$, e) and q(a:le), respectively. We define ((...))8 -- (...), - 
(...). We obtain 
A logp(sil e) = 
k 
1 
+   (((ZXOkZXO))s, -- (ZXOk)s ' (ZXO)s, + (ZXOk) 
k,l 
+ higher order terms (8) 
To first order, setting Eq. 8 equal to zero we obtain 
0 = y((AOk))s = (logp(X))s -logq(si) + const., 
(9) 
k 
where we have absorbed all terms independent of i into a constant. Thus, we find the 
solution 
1 
q(si) = //exp ((logp(a;))s,) (10) 
in which the constants Zi follow from normalisation. The first order term is equivalent to 
the standard mean field equations, obtained from Jensens' inequality. 
The correction with second order terms is obtained in the same way, again dropping terms 
(11) 
independent of i: 
q(si) = iexp (logp(x))s +  y ((aPkaqSt)s -(aPk)s 
k,l 
were, again, the constants Zi follow from normalisation. These equations, which form the 
main result of this paper, are generalization of the mean field equations with TAP correc- 
tions for directed graphical models. Both left and right-hand size of Eqs. 10 and 11 depend 
on the unknown probability distribution q($) and can be solved by fixed point iteration. 
3 Complexity and single-overlap graphs 
The complexity of the first order equations Eq. 10 is exponential in the number of variables 
in the potentials 0k of ?: if the maximal clique size is c, then for each i we need of the 
order of ri exp(c) computations, where ri is the number of cliques that contain node i. 
The second term scales worse, since one must compute averages over the union of two 
overlapping cliques and because of the double sum. However, things are not so bad. First 
Figure 1: An example of a single-overlap graph. Left: The chest clinic model 
(ASIA)(Lauritzen and Spiegelhalter, 1988). Right: nodes within one potential a re grouped 
together, showing that potentials share at most one node. 
of all, notice that the sum over k and l can be restricted to overlapping cliques (k 91 l  0) 
and that i must be in either k or l or both (i E k U l). Denote by n n the number of cliques 
that have at least one variable in common with clique k and denote by moverlap ---- maxn nn 
Then, the sum over k and l contains not more than ioverlap terms. 
Each term is an average over the union of two cliques, which can be worse case of size 2c- 1 
(when only one variable is shared). However, since (A(pnA(pt)s = ((A(pn)nc t A(pt)s  
((')nat means expectation wrt q conditioned on the variables in k 91 l) we can precompute 
(A(Pn) nat for all pairs of overlapping cliques k, l, for all states in k 91l. Therefore, the worse 
case complexity of the second order term is less than ninoverlap exp(c). Thus, we see that 
the second order method has the same exponential complexity as the first order method, but 
with a different polynomial prefactor. Therefore, the first or second order method can be 
applied to directed graphical models as long as the number of parents is reasonably small. 
The fact that the second order term has a worse complexity than the first order term is in 
contrast to Boltzmann machines, in which the TAP approximation has the same complexity 
as the standard mean field approximation. This phenomenon also occurs for a special class 
of DAGs, which we call single-overlap graphs. These are graphs in which the potentials Ok 
share at most one node. Figure 1 shows an example of a single-overlap graph. 
For single overlap graphs, we can use the first order result Eq. 9 to simplify the second 
order correction. The derivation rather tedious and we just present the result 
1 
q(si) = -- exp 
Zi 
(logp(X))s, 
1 
l,i61 
- y y (((Acpt))sjACpt)s,) (12) 
t,it j7i 
which has a complexity that is of order ni (c - 1) exp(c). For probability distributions with 
many small potentials that share nodes with many other potentials, Eq. 12 is more efficient 
than Eq. 11. For instance, for Boltzmann Machines ni -- moverlap -- n -- 1 and c = 2. In 
this case, Eq. 12 is identical to the TAP equations (Thouless et al., 1977). 
4 Sigmoid belief networks 
In this section, we consider sigmoid belief networks as an interesting class of directed 
graphical models. The reason is, that one can expand in terms of the couplings instead of 
the potentials which is more efficient. The sigmoid belief network is defined as 
p(x) = II (13) 
i 
(a) (b) (c) (d) 
Figure 2: Interpretation of different interaction terms appearing in Eq. 16. The open and 
shaded nodes are hidden and evidence nodes, respectively (except in (a), where k can be 
any node). Solid arrows indicate the graphical structure in the network. Dashed arrows 
indicate interaction terms that appear in Eq. 16. 
where o'(z) = (1 + exp(-2z)) -, zi = q-1 and hi is the local field: hi(z) = 
Ej=i WijXj q- Oi' 
We separate the viables in evidence viables e and hidden variables s: x = (s, e). When 
couplings from hidden nodes to either hidden or evidence nodes are zero, Wij  O, i  e, s 
and j G s, the probability distributions p(sle ) and p(e) reduce to 
p(sle )  q(s) = a(siO) (14) 
iGs 
p(e)  r(e) = a(eiO) (15) 
iGe 
where O = jGe WijCj  Oi depends on the evidence. 
We expand to second order around this tractable distribution and obtain 
mi = tanh mjwi+Oi+2r(-e)ewi mi(1 22 
e ke ks 
+ - q 
kGe kGe,lGs 
+ 2  (1-m})r(-et)etwtwi) (16) 
kGs,lGe 
with mi = (Si}q  (Si}p and r is given by Eq. 15. 
The different terms that appe in this equation can be easily intereted. The first te 
describes the lowest order forwd influence on node i from its parents. Pents can be 
either evidence or hidden nodes (fig. 2a). The second term is the bias Oi. The third te 
describes to lowest order the effect of Bayes' rule: it affects mi such that the observed 
evidence on its children becomes most probable (fig. 2b). Note, that this te is absent 
when the evidence is explained by the evidence nodes themselves: r(e) = 1. The fourth 
and fifth terms are the quadratic contributions to the first and third terms, respectively. The 
sixth te describes 'explaining away'. It describes the effect of hidden node l on node i, 
when both have a common observed child k (fig. 2c). The last term describes the effect on 
node i when its grandchild is observed (fig. 2d). 
Note, that these equations e different from Eq. 10. When one applies Eq. 10 to sigmoid 
belief networks, one requires additional approximations to compute (log a(xh)} (Saul 
et al., 1996). 
0.07 
0.06 
., 0.05 
' 0.04 
0.03 
0.02 
0.01 
I 
I 
I 
I 
I 
10 20 30 
n 1 
0.7 
0.6 
0.5 
0.4 
0.3 
0.2 
0.1 
0.5 1 
J 
Figure 3: Second order approximation for fully connected sigmoid belief network of n 
nodes. a) nodes 1,..., n are hidden (white) and nodes n + 1,..., n are clamped (grey), 
n = n/2; b) CPU time for exact inference (dashed) and second order approximation 
(solid) versus nx (J = 0.5); c) RMS of hidden node exact marginals (solid) and RMS error 
of second order approximation (dashed) versus coupling strength J, (n = 10). 
Since only feed-forward connections are present, one can order the nodes such that wij = 0 
for i < j. Then the first order mean field equations can be solved in one single sweep 
starting with node 1. The full second order equations can be solved by iteration, starting 
with the first order solution. 
5 Numerical results 
We illustrate the theory with two toy problems. The first one is inference in Lauritzen's 
chest clinic model (ASIA), defined on 8 binary variables x = {A, T, $, L, B, E, X, D} 
(see figure 1, and (Lauritzen and Spiegelhalter, 1988) for more details about the model). We 
computed exact marginals and approximate marginals using the approximating methods up 
to first (Eq. 10) and second order (Eq. 11), respectively. The approximate marginals are 
determined by sequential iteration of (10) and (11), starting at q(ci) = 0.5 for all variables 
i. The maximal error in the marginals using the first and second order method is 0.213 
and 0.061, respectively. We verified that the single-overlap expression Eq. 12 gave similar 
results. 
In fig. 3, we assess the accuracy and CPU time of the second order approximation Eq. 16 
for sigmoid belief networks. We generate random fully connected sigmoid belief networks 
with wij from a normal distribution with mean zero and variance d2n and Oi = 0. We 
observe in fig. 3b that the computation time is very fast: For n = 500, we have obtained 
convergence in 37 second on a Pentium 300 Mhz processor. The accuracy of the method 
depends on the size of the weights and is computed for a network of n = 10 (fig. 3c). In 
(Kappen and Wiegerinck, 2001), we compare this approach to Saul's variational approach 
(Saul et al., 1996) and show that our approach is much faster and slightly more accurate. 
6 Discussion 
In this paper, we computed a second order mean field approximation for directed graphical 
models. We show that the second order approximation gives a significant improvement 
over the first order result. The method does not use explicitly that the graph is directed. 
Therefore, the result is equally valid for Markov graphs. 
The complexity of the first and second order approximation is of O(niexp(c)) and 
O(ioverlap exp(c)), respectively, with c the number of variables in the largest poten- 
tial. For single-overlap graphs, one can rewrite the second order equation such that the 
computational complexity reduces to O(ni(c- 1)exp(c)). Boltzmann machines and the 
Asia network are examples of single-overlap graphs. 
For large c, additional approximations are required, as was proposed by (Saul et al., 1996) 
for the first order mean field equations. It is evident, that such additional approximations 
are then also required for the second order mean field equations. 
It has been reported (Barber and Wiegerinck, 1999; Wiegerinck and Kappen, 1999) that 
similar numerical improvements can be obtained by using a very different approach, which 
is to use an approximating distribution q that is not factorized, but still tractable. A promis- 
ing way to proceed is therefore to combine both approaches and to do a second order 
expansion aroud a manifold of distributions with non-factorized yet tractable distributions. 
In this approach the sufficient statistics of the tractable structure is expanded, rather than 
the marginal probabilities. 
Acknowledgments 
This research was supported in part by the Dutch Technology Foundation (STW). 
References 
Barber, D. and Wiegerinck, W. (1999). Tractable variational structures for approximating graphi- 
cal models. In Keams, M., Solla, S., and Cohn, D., editors, Advances in Neural Information 
Processing Systems, volume 11 of Advances in Neural Information Processing Systems, pages 
183-189. MIT Press. 
Kappen, H. and Rodriguez, F. (1998). Efficient learning in Boltzmann Machines using linear response 
theory. Neural Computation, 10:1137-1156. 
Kappen, H. and Spanjers, J. (1999). Mean field theory for asymmetric neural networks. Physical 
Review E, 61:5658-5663. 
Kappen, H. and Wiegerinck, W. (2001). Mean field theory for graphical models. In Saad, D. and 
Opper, M., editors, Advanced mean field theory. MIT Press. 
Lauritzen, S. and Spiegelhalter, D. (1988). Local computations with probabilties on graphical struc- 
tures and their application to expert systems. J. Royal Statistical society B, 50:154-227. 
Plefka, T. (1982). Convergence condition of the TAP equation for the infinite-range Ising spin glass 
model. Journal of Physics A, 15:1971-1978. 
Saul, L., Jaakkola, T., and Jordan, M. (1996). Mean field theory for sigmoid belief networks. Journal 
of artificial intelligence research, 4:61-76. 
Thouless, D., Anderson, P., and Palmer, R. (1977). Solution of 'Solvable Model of a Spin Glass'. 
Phil. Mag., 35:593-601. 
Wiegerinck, W. and Kappen, H. (1999). Approximations of bayesian networks through kl minimisa- 
tion. New Generation Computing, 18:167-175. 
